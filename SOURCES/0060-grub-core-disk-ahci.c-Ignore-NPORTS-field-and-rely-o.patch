From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Vladimir Serbinenko <phcoder@gmail.com>
Date: Thu, 20 Feb 2014 10:11:43 +0100
Subject: [PATCH] * grub-core/disk/ahci.c: Ignore NPORTS field and rely on PI
 exclusively.

---
 grub-core/disk/ahci.c | 2 +-
 ChangeLog             | 5 +++++
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/grub-core/disk/ahci.c b/grub-core/disk/ahci.c
index 5e4a6397a49..89365cd0925 100644
--- a/grub-core/disk/ahci.c
+++ b/grub-core/disk/ahci.c
@@ -322,7 +322,7 @@ grub_ahci_pciinit (grub_pci_device_t dev,
 
   grub_dprintf ("ahci", "GLC:%x\n", hba->global_control);
 
-  nports = (hba->cap & GRUB_AHCI_HBA_CAP_NPORTS_MASK) + 1;
+  nports = (GRUB_AHCI_HBA_CAP_NPORTS_MASK) + 1;
 
   grub_dprintf ("ahci", "%d AHCI ports, PI = 0x%x\n", nports,
 		hba->ports_implemented);
diff --git a/ChangeLog b/ChangeLog
index 5237631583a..be41aa51f65 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,8 @@
+2014-02-20  Vladimir Serbinenko  <phcoder@gmail.com>
+
+	* grub-core/disk/ahci.c: Ignore NPORTS field and rely on PI
+	exclusively.
+
 2014-02-04  Paulo Flabiano Smorigo  <pfsmorigo@br.ibm.com>
 
 	Add bootpath parser for open firmware.
